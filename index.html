<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…±äº«ä¸‹ç­å€’æ•¸</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #form { margin-bottom: 1rem; }
    #list { margin-top: 1rem; }
    .item { padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .name { font-weight: bold; }
    .timer { float: right; }
  </style>
  <!-- 1. è¼‰å…¥ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>å…±äº«ä¸‹ç­å€’æ•¸</h1>

<!-- ç®¡ç†å€ -->
<div id="adminArea" style="margin-bottom:1rem;">
  <input type="password" id="adminPwd" placeholder="ç®¡ç†å¯†ç¢¼" />
  <button id="adminLogin">ç™»å…¥ç®¡ç†å“¡</button>
</div>

<!-- å ±åˆ°è¡¨å–® -->
<div id="form">
  <input type="text" id="yourName" placeholder="è«‹è¼¸å…¥å§“å" />
  <input type="time" id="yourStart" value="08:00" />
  <button id="btnGo">æˆ‘è¦å ±åˆ°</button>
</div>

<!-- é¡¯ç¤ºåˆ—è¡¨ -->
<div id="list"></div>

<!-- ç•™è¨€æ¿æµ®å‹•å°åœ–ç¤º -->
<div id="chatToggle" style="
    position:fixed; bottom:20px; right:20px;
    width:50px; height:50px;
    background:#007bff; color:#fff; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; z-index:9999;">
  ğŸ’¬
</div>

<!-- ç•™è¨€æ¿ä¸»è¦–çª—ï¼ˆé è¨­éš±è—ï¼‰ -->
<div id="chatBox" style="
    position:fixed; bottom:20px; right:20px;
    width:300px; height:300px;
    border:1px solid #aaa; background:#fff;
    border-radius:8px;
    display:none; flex-direction:column; resize:both; overflow:auto; z-index:9998;">
  <div style="display:flex; justify-content:space-between; background:#eee; padding:5px; cursor:move;">
    <span>ç•™è¨€æ¿</span>
    <button id="chatClose">âœ–</button>
  </div>
  <div id="chatMessages" style="flex:1; padding:5px; overflow:auto;"></div>
  <div style="display:flex; border-top:1px solid #ddd;">
    <input id="chatInput" placeholder="è¼¸å…¥ç•™è¨€..." style="flex:1; border:none; padding:5px;">
    <button id="chatSend">é€å‡º</button>
  </div>
</div>

<script>
  // ğŸ”¸ åˆå§‹åŒ– Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB8lK1b6nx2hunGNwHutpBCO-BeKO5XntQ",
    authDomain: "countdown-11b34.firebaseapp.com",
    databaseURL: "https://countdown-11b34-default-rtdb.firebaseio.com",
    projectId: "countdown-11b34",
    storageBucket: "countdown-11b34.appspot.com",
    messagingSenderId: "338264464503",
    appId: "1:338264464503:web:507ef5a71113162a91fa72",
    measurementId: "G-TE12G16JLZ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const WORK_MS  = 8 * 3600 * 1000;
  const BREAK_MS = 1 * 3600 * 1000;
  const ADMIN_PWD = "admin123";
  let isAdmin = false;

  // è‡ªå‹•è¨˜ä½å§“å
  const nameInput = document.getElementById('yourName');
  const savedName = localStorage.getItem('userName');
  if(savedName) nameInput.value = savedName;
  nameInput.addEventListener('input', ()=>{localStorage.setItem('userName', nameInput.value.trim());});

  // å ±åˆ°
  document.getElementById('btnGo').onclick = ()=>{
    const name = nameInput.value.trim();
    const start = document.getElementById('yourStart').value;
    if(!name || !start) return alert('è«‹è¼¸å…¥å§“ååŠä¸Šç­æ™‚é–“');
    const key = name.replace(/\s+/g,'_');
    db.ref('checkin/'+key).set({name, startTime:start, timestamp:Date.now()});
    localStorage.setItem('userName', name);
  };

  // ç®¡ç†å“¡ç™»å…¥
  document.getElementById('adminLogin').onclick = ()=>{
    const val = document.getElementById('adminPwd').value;
    if(val===ADMIN_PWD){
      isAdmin = true;
      alert('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ');
      renderList();
    }else alert('å¯†ç¢¼éŒ¯èª¤');
  };

  // é¡¯ç¤ºåå–®
  const listEl = document.getElementById('list');
  db.ref('checkin').on('value', snap=>{
    window.currentData = snap.val() || {};
    renderList();
  });

  function renderList(){
    const data = window.currentData || {};
    listEl.innerHTML = '';
    Object.values(data)
      .sort((a,b)=> a.name.localeCompare(b.name))
      .forEach(item=>{
        const div = document.createElement('div');
        div.className='item';
        const key = item.name.replace(/\s+/g,'_');
        div.innerHTML=`
          <span class="name">${item.name}</span>
          <span class="timer" data-start="${item.startTime}" data-key="${key}">--:--:--</span>
          ${isAdmin?`<button class="delBtn" data-key="${key}">åˆªé™¤</button>`:''}
        `;
        listEl.appendChild(div);
      });
    if(isAdmin){
      document.querySelectorAll('.delBtn').forEach(btn=>{
        btn.onclick = ()=>db.ref('checkin/'+btn.dataset.key).remove();
      });
    }
  }

  // å€’æ•¸èˆ‡è‡ªå‹•åˆªé™¤
  setInterval(()=>{
    document.querySelectorAll('.timer').forEach(el=>{
      const now = new Date();
      const [hh,mm] = el.dataset.start.split(':').map(n=>parseInt(n));
      const dtStart = new Date(); dtStart.setHours(hh,mm,0,0);
      let dtEnd = new Date(dtStart.getTime()+WORK_MS+BREAK_MS);
      if(now>dtEnd){db.ref('checkin/'+el.dataset.key).remove(); return;}
      const diff = dtEnd-now;
      const H = String(Math.floor(diff/1000/3600)).padStart(2,'0');
      const M = String(Math.floor(diff/1000/60%60)).padStart(2,'0');
      const S = String(Math.floor(diff/1000%60)).padStart(2,'0');
      el.textContent=`${H}:${M}:${S}`;
    });
  },1000);

  // ğŸ’¬ ç•™è¨€æ¿
  const chatBox = document.getElementById('chatBox');
  const chatToggle = document.getElementById('chatToggle');
  const chatClose = document.getElementById('chatClose');
  const chatMsg = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');

  const currentName = ()=>nameInput.value.trim()||'åŒ¿å';

  chatToggle.onclick = ()=>{chatBox.style.display='flex'; chatToggle.style.display='none';};
  chatClose.onclick = ()=>{chatBox.style.display='none'; chatToggle.style.display='flex';};

  chatSend.onclick = ()=>{
    const text = chatInput.value.trim();
    if(!text) return;
    db.ref('messages').push({name:currentName(), text, timestamp:Date.now()});
    chatInput.value='';
  };

  db.ref('messages').on('value', snap=>{
    const msgs = snap.val()||{};
    chatMsg.innerHTML='';
    Object.values(msgs)
      .sort((a,b)=>a.timestamp-b.timestamp)
      .forEach(m=>{
        const p=document.createElement('div');
        const t = new Date(m.timestamp).toLocaleTimeString();
        p.textContent=`[${t}] ${m.name}: ${m.text}`;
        chatMsg.appendChild(p);
      });
    chatMsg.scrollTop = chatMsg.scrollHeight;
  });
</script>
</body>
</html>

