<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…±äº«ä¸‹ç­å€’æ•¸</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #form { margin-bottom: 1rem; }
    #list { margin-top: 1rem; }
    .item { padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .name { font-weight: bold; }
    .timer { float: right; }
  </style>
  <!-- 1. è¼‰å…¥ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>å…±äº«ä¸‹ç­å€’æ•¸</h1>

<!-- ç®¡ç†å€ -->
<div id="adminArea" style="margin-bottom:1rem;">
  <input type="password" id="adminPwd" placeholder="ç®¡ç†å¯†ç¢¼" />
  <button id="adminLogin">ç™»å…¥ç®¡ç†å“¡</button>
</div>

<!-- å ±åˆ°è¡¨å–® -->
<div id="form">
  <input type="text" id="yourName" placeholder="è«‹è¼¸å…¥å§“å" />
  <input type="time" id="yourStart" value="08:00" />
  <button id="btnGo">æˆ‘è¦å ±åˆ°</button>
</div>

<!-- é¡¯ç¤ºåˆ—è¡¨ -->
<div id="list"></div>


<script>
  // ğŸ”¸ åˆå§‹åŒ– Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCT8V-5TO5HHjpQwclHFiLBxGbzc64wYm8",
    authDomain: "countdown-simple.firebaseapp.com",
    databaseURL: "https://countdown-simple-default-rtdb.firebaseio.com",
    projectId: "countdown-simple",
    storageBucket: "countdown-simple.firebasestorage.app",
    messagingSenderId: "984182218677",
    appId: "1:984182218677:web:d0213b755db299f09203fc",
    measurementId: "G-V53TYNGZZN"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const WORK_MS  = 8 * 3600 * 1000;
  const BREAK_MS = 1 * 3600 * 1000;
  const ADMIN_PWD = "admin123";
  let isAdmin = false;

  // è‡ªå‹•è¨˜ä½å§“å
  const nameInput = document.getElementById('yourName');
  const savedName = localStorage.getItem('userName');
  if(savedName) nameInput.value = savedName;
  nameInput.addEventListener('input', ()=>{localStorage.setItem('userName', nameInput.value.trim());});

  // å ±åˆ°
  document.getElementById('btnGo').onclick = ()=>{
    const name = nameInput.value.trim();
    const start = document.getElementById('yourStart').value;
    if(!name || !start) return alert('è«‹è¼¸å…¥å§“ååŠä¸Šç­æ™‚é–“');
    const key = name.replace(/\s+/g,'_');
    db.ref('checkin/'+key).set({name, startTime:start, timestamp:Date.now()});
    localStorage.setItem('userName', name);
  };

  // ç®¡ç†å“¡ç™»å…¥
  document.getElementById('adminLogin').onclick = ()=>{
    const val = document.getElementById('adminPwd').value;
    if(val===ADMIN_PWD){
      isAdmin = true;
      alert('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ');
      renderList();
    }else alert('å¯†ç¢¼éŒ¯èª¤');
  };

  // é¡¯ç¤ºåå–®
  const listEl = document.getElementById('list');
  db.ref('checkin').on('value', snap=>{
    window.currentData = snap.val() || {};
    renderList();
  });

  function renderList(){
    const data = window.currentData || {};
    listEl.innerHTML = '';
    Object.values(data)
      .sort((a,b)=> a.name.localeCompare(b.name))
      .forEach(item=>{
        const div = document.createElement('div');
        div.className='item';
        const key = item.name.replace(/\s+/g,'_');
        div.innerHTML=`
          <span class="name">${item.name}</span>
          <span class="timer" data-start="${item.startTime}" data-key="${key}">--:--:--</span>
          ${isAdmin?`<button class="delBtn" data-key="${key}">åˆªé™¤</button>`:''}
        `;
        listEl.appendChild(div);
      });
    if(isAdmin){
      document.querySelectorAll('.delBtn').forEach(btn=>{
        btn.onclick = ()=>db.ref('checkin/'+btn.dataset.key).remove();
      });
    }
  }

  // å€’æ•¸èˆ‡è‡ªå‹•åˆªé™¤
  setInterval(()=>{
    document.querySelectorAll('.timer').forEach(el=>{
      const now = new Date();
      const [hh,mm] = el.dataset.start.split(':').map(n=>parseInt(n));
      const dtStart = new Date(); dtStart.setHours(hh,mm,0,0);
      let dtEnd = new Date(dtStart.getTime()+WORK_MS+BREAK_MS);
      if(now>dtEnd){db.ref('checkin/'+el.dataset.key).remove(); return;}
      const diff = dtEnd-now;
      const H = String(Math.floor(diff/1000/3600)).padStart(2,'0');
      const M = String(Math.floor(diff/1000/60%60)).padStart(2,'0');
      const S = String(Math.floor(diff/1000%60)).padStart(2,'0');
      el.textContent=`${H}:${M}:${S}`;
    });
  },1000);
</script>
</body>
</html>

